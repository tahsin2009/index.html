<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CodeShare — programming social feed (demo)</title>

<!-- Prism.js syntax highlighting -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<!-- Load more languages if needed -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>



<style>
  :root{
    --bg: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    --card:#ffffff;
    --muted:#777;
    --accent:#111;
    --glass: rgba(255,255,255,0.03);
    --glow: 0 6px 18px rgba(0,0,0,0.25);
  }
  html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
  body{
    background:var(--bg);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px;
  }
  .phone{
    width:380px;
    height:780px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05));
    border-radius:18px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    border: 8px solid var(--bg);
  }
  header.appbar{
    padding:10px 14px;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    background:transparent;
  }
  .tabs{
    display:flex;
    gap:8px;
    align-items:center;
  }
  .tab{
    font-size:13px;
    color:#eee;
    padding:6px 8px;
    border-radius:8px;
    cursor:pointer;
    opacity:0.9;
  }
  .tab.active{
    background:var(--card);
    color:var(--accent);
    box-shadow: var(--glow);
    font-weight:600;
  }
  .main{
    flex:1;
    background: #fff;
    border-top-left-radius:20px;
    border-top-right-radius:20px;
    padding:14px;
    overflow:auto;
  }
  /* Upload page layout */
  .upload-area{
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:center;
  }
  .drop{
    width:100%;
    height:220px;
    border-radius:10px;
    border:2px dashed #ddd;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#666;
    background:#fafafa;
    position:relative;
  }
  .drop img, .drop video{ max-width:100%; max-height:100%; border-radius:8px; object-fit:cover; }
  .input, .textarea{
    width:100%;
    padding:10px 12px;
    border-radius:8px;
    border:1px solid #e3e3e3;
    font-size:14px;
  }
  .small-btn{
    display:inline-flex;
    align-items:center;
    gap:8px;
    background:#f3f3f3;
    border-radius:8px;
    padding:8px 12px;
    cursor:pointer;
    border:1px solid #ddd;
  }
  .post-btn{
    width:100%;
    padding:12px;
    border-radius:10px;
    background:var(--accent);
    color:#fff;
    font-weight:700;
    border:none;
    cursor:pointer;
  }

  /* Feed cards */
  .post{
    background:transparent;
    border-radius:12px;
    padding:12px;
    margin-bottom:12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    border:1px solid #f0f0f0;
  }
  .meta{
    display:flex;
    gap:10px;
    align-items:center;
    margin-bottom:8px;
  }
  .avatar{
    width:38px;height:38px;border-radius:50%;background:#ddd;display:flex;align-items:center;justify-content:center;font-weight:700;color:#555;
  }
  .username{font-weight:700;font-size:14px}
  .posted-time{font-size:12px;color:var(--muted)}
  .post-img{width:100%;height:auto;border-radius:10px;margin:8px 0;max-height:360px;object-fit:cover}
  .actions{display:flex;gap:12px;align-items:center;margin-top:6px}
  .action{cursor:pointer;display:flex;gap:8px;align-items:center;color:#444;font-size:13px}
  .counter{font-weight:600}
  .desc{color:#333;margin-top:8px;white-space:pre-wrap}
  .code-block {
  background:#0f1720;
  color:#e6f2ff;
  padding:10px;
  border-radius:8px;
  font-family:monospace;
  font-size:13px;
  overflow:auto;
  margin-top:8px;
  max-height:120px; /* default collapsed height */
  position:relative;
}

.code-block.expanded {
  max-height:none; /* allow full height */
}

.show-code-btn {
  margin-top:6px;
  background:#f3f3f3;
  border:1px solid #ddd;
  border-radius:6px;
  padding:6px 10px;
  font-size:13px;
  cursor:pointer;
  display:inline-block;
}


  /* profile */
  .profile-card{display:flex;gap:12px;align-items:center;padding:12px;border-radius:10px;background:#fafafa;border:1px solid #eee;margin-bottom:12px}
  .profile-hero{height:120px;background:#2e2e2e;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:22px}
  .small-muted{font-size:13px;color:var(--muted);}

  /* comments & auth popup as mobile bottom sheet */
.modal {
  position: fixed;
  left: 0;
  top: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.45);
  display: flex;
  align-items: flex-end; /* bottom sheet */
  justify-content: center;
  padding: 0;
  z-index: 1000;
}
.modal .card {
  width: 100%;
  max-height: 85vh;
  background: #fff;
  border-top-left-radius: 18px;
  border-top-right-radius: 18px;
  padding: 16px;
  box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
  overflow-y: auto;
  animation: slideUp .25s ease;
}

.code-wrap .code-block {
  border-radius: 6px;
  padding: 10px;
  background: #0f0f0f;  /* adjust to match your theme */
  color: #f8f8f2;
  box-shadow: 0 2px 6px rgba(0,0,0,0.4);
}
.toggle-code {
  margin-top: 8px;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
}




@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}
  .comments-list{max-height:300px;overflow:auto;margin-bottom:8px}
  .comment{padding:8px;border-bottom:1px solid #f0f0f0}

  /* small helpers */
  .muted{color:var(--muted);}
  .row{display:flex;gap:8px;align-items:center;}
  footer.bottom-nav{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 6px;background:transparent;}
  .icon-btn{background:transparent;border:none;cursor:pointer;color:#fff}
  .danger{color:crimson}
  @media (max-width:420px){
    .phone{width:92vw;height:92vh}
  }
</style>
</head>
<body>
  <div class="phone" role="application" aria-label="CodeShare demo app">
    <header class="appbar">
      <div class="tabs" id="tabs">
        <div class="tab active" data-page="feed">feed</div>
        <div class="tab" data-page="upload">upload</div>
        <div class="tab" data-page="saved">saved</div>
        <div class="tab" data-page="profile">profile</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="currentUserName" style="color:#fff;font-weight:600">Guest</div>
      </div>
    </header>

    <main class="main" id="main">
      <!-- Feed page -->
      <section id="feedPage">
        <div id="feedList"></div>
      </section>

      <!-- Upload page -->
      <section id="uploadPage" style="display:none">
        <div class="upload-area">
          <div class="drop" id="dropZone">
            <div id="dropText">Click to upload image or video</div>
            <img id="previewImg" style="display:none"/>
            <video id="previewVid" style="display:none" controls></video>
          </div>
          <input id="fileInput" type="file" accept="image/*,video/*" style="display:none"/>
          <input id="desc" class="input" placeholder="add post description"/>
          <textarea id="sourceCode" class="textarea" rows="4" placeholder="add source code (optional)"></textarea>
          <label class="small-btn"><input id="codePublic" type="checkbox"/> Make source code public</label>
          <button class="post-btn" id="postBtn">Post</button>
        </div>
      </section>

      <!-- Saved page -->
      <section id="savedPage" style="display:none">
        <h3>Saved posts</h3>
        <div id="savedList"></div>
      </section>

      <!-- Profile page -->
      <section id="profilePage" style="display:none">
        <div class="profile-card">
          <div style="flex:1">
            <div class="username" id="profileName">Guest</div>
            <div class="small-muted" id="profileEmail">Not signed in</div>
            <div style="margin-top:8px;">
              <button id="btnLogout" class="small-btn">Log out</button>
              <button id="btnLogin" class="small-btn">Sign up / Login</button>
            </div>
          </div>
          <div style="width:84px;text-align:center">
            <div class="avatar" id="profileAvatar">G</div>
          </div>
        </div>
        <div>
          <h4>Your posts</h4>
          <div id="myPosts"></div>
        </div>
      </section>
    </main>

    <footer class="bottom-nav">
      <div style="color:#fff;font-size:12px">CodeShare — demo</div>
      <div style="color:#fff;font-size:12px">Local only</div>
    </footer>
  </div>

  <!-- simple modal container -->
  <div id="modalRoot" style="display:none"></div>

<script>
/* ---------------------------
  Simple front-end demo app
  - Local persistence via localStorage
  - Replace storage calls with calls to your backend (Firebase) to enable real multi-user online usage
--------------------------- */

const APPKEY = 'codeshare_v1';
const local = {
  get(){ try { return JSON.parse(localStorage.getItem(APPKEY)||'{}') } catch(e){ return {} } },
  set(obj){ localStorage.setItem(APPKEY, JSON.stringify(obj)); }
};

let state = {
  user: null, // {id,name,email}
  data: null // loaded storage
};

function init(){
  // load state
  state.data = local.get();
  if(!state.data.posts) state.data.posts = []; // array of posts
  if(!state.data.users) state.data.users = []; // array of users
  if(!state.data.saved) state.data.saved = {}; // map userId->array of postIds

  // UI events
  setupTabs();
  document.getElementById('dropZone').addEventListener('click',()=>document.getElementById('fileInput').click());
  document.getElementById('fileInput').addEventListener('change', handleFile);
  document.getElementById('postBtn').addEventListener('click', handlePost);
  document.getElementById('btnLogin').addEventListener('click', showAuth);
  document.getElementById('btnLogout').addEventListener('click', logout);

  // initial render

document.querySelectorAll('.show-code-btn').forEach(btn => {
  btn.addEventListener('click', e => {
    const id = e.currentTarget.dataset.id;
    const block = document.getElementById(`code-${id}`);
    block.classList.toggle('expanded');
    e.currentTarget.textContent = block.classList.contains('expanded')
      ? 'Hide source code'
      : 'Show source code';
  });
});



  
  renderFeed();
  renderProfile();
  renderSaved();

  // set default guest user
  setUserFromStorage();
}

function setUserFromStorage(){
  const uid = localStorage.getItem('codeshare_current_user');
  if(uid){
    const u = state.data.users.find(x=>x.id===uid);
    if(u) { state.user = u; }
  }
  updateUserUI();
}

function updateUserUI(){
  document.getElementById('currentUserName').textContent = state.user ? state.user.name : 'Guest';
  document.getElementById('profileName').textContent = state.user ? state.user.name : 'Guest';
  document.getElementById('profileEmail').textContent = state.user ? state.user.email : 'Not signed in';
  document.getElementById('profileAvatar').textContent = state.user ? (state.user.name[0]||'U').toUpperCase() : 'G';
  // toggle auth buttons
  document.getElementById('btnLogin').style.display = state.user ? 'none' : 'inline-flex';
  document.getElementById('btnLogout').style.display = state.user ? 'inline-flex' : 'none';
  renderMyPosts();
}

function setupTabs(){
  document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click', (e)=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      e.currentTarget.classList.add('active');
      const page = e.currentTarget.dataset.page;
      showPage(page);
    })
  })
}

function showPage(page){
  ['feed','upload','saved','profile'].forEach(p=>{
    document.getElementById(p+'Page').style.display = p===page ? '' : 'none';
  });
  if(page==='feed') renderFeed();
  if(page==='saved') renderSaved();
  if(page==='profile') renderProfile();
}

function handleFile(e){
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    const url = reader.result;
    // detect image or video
    if(f.type.startsWith('image/')){
      document.getElementById('previewImg').src = url;
      document.getElementById('previewImg').style.display = '';
      document.getElementById('previewVid').style.display = 'none';
      document.getElementById('dropZone').dataset.upload = url;
    } else if(f.type.startsWith('video/')){
      document.getElementById('previewVid').src = url;
      document.getElementById('previewVid').style.display = '';
      document.getElementById('previewImg').style.display = 'none';
      document.getElementById('dropZone').dataset.upload = url;
    } else {
      alert('Unsupported file type. Please upload image or video.');
    }
  };
  reader.readAsDataURL(f);
}

function handlePost(){
  const url = document.getElementById('dropZone').dataset.upload;
  const desc = document.getElementById('desc').value.trim();
  const code = document.getElementById('sourceCode').value.trim();
  const publicCode = document.getElementById('codePublic').checked;
  if(!state.user){
    alert('Please sign up / login to post.');
    showAuth();
    return;
  }
  if(!url){
    alert('Choose an image or video first.');
    return;
  }
  const post = {
    id: 'p_' + Date.now() + '_' + Math.random().toString(36).slice(2,8),
    userId: state.user.id,
    userName: state.user.name,
    avatarLetter: (state.user.name[0]||'U').toUpperCase(),
    createdAt: Date.now(),
    media: url,
    mediaType: url.startsWith('data:video') ? 'video' : 'image',
    description: desc,
    sourceCode: code,
    sourcePublic: publicCode,
    likes: [],
    comments: []
  };
  state.data.posts.unshift(post);
  saveData();
  // reset upload UI
  document.getElementById('dropZone').dataset.upload = '';
  document.getElementById('previewImg').style.display = 'none';
  document.getElementById('previewVid').style.display = 'none';
  document.getElementById('desc').value = '';
  document.getElementById('sourceCode').value = '';
  document.getElementById('codePublic').checked = false;
  alert('Posted!');
  showPage('feed');
  document.querySelector('.tab[data-page="feed"]').click();
}

function saveData(){
  local.set(state.data);
}

function renderFeed(){
  const feed = document.getElementById('feedList');
  feed.innerHTML = '';
  if(state.data.posts.length===0){
    feed.innerHTML = '<div style="padding:18px;color:#666">No posts yet — create one from the upload tab.</div>';
    return;
  }
  state.data.posts.forEach(post=>{
    const el = document.createElement('div');
    el.className = 'post';
    el.innerHTML = `
      <div class="meta">
        <div class="avatar" aria-hidden="true">${escapeHtml(post.avatarLetter||post.userName[0]||'U')}</div>
        <div style="flex:1">
          <div class="row"><div class="username">${escapeHtml(post.userName)}</div><div style="margin-left:8px" class="posted-time muted">${timeAgo(post.createdAt)}</div></div>
        </div>
        <div><button class="small-btn" data-id="${post.id}" title="Options">⋯</button></div>
      </div>
      ${post.mediaType==='image' ? `<img class="post-img" src="${post.media}" />` : `<video class="post-img" src="${post.media}" controls></video>`}
      <div class="desc">${escapeHtml(post.description||'')}</div>
      ${post.sourceCode && post.sourcePublic ? `
  <div>
    <pre class="code-block" id="code-${post.id}"><code class="language-javascript">${escapeHtml(post.sourceCode)}</code></pre>
    
    <button class="show-code-btn" data-id="${post.id}">Show source code</button>
  </div>
` : ''}

      <div class="actions">
        <div class="action likeBtn" data-id="${post.id}">❤️ <span class="counter">${post.likes.length}</span></div>
        <div class="action commentBtn" data-id="${post.id}">💬 <span class="counter">${post.comments.length}</span></div>
        <div class="action saveBtn" data-id="${post.id}">${isSaved(post.id) ? '🔖 saved' : '🔖 save'}</div>
        ${state.user && state.user.id===post.userId ? `<div class="action danger delBtn" data-id="${post.id}">🗑️ delete</div>` : ''}
      </div>
    `;
    feed.appendChild(el);
  });


  document.querySelectorAll('.show-code-btn').forEach(btn => {
  btn.addEventListener('click', e => {
    const id = e.currentTarget.dataset.id;
    const block = document.getElementById(`code-${id}`);
    block.classList.toggle('expanded');
    e.currentTarget.textContent = block.classList.contains('expanded')
      ? 'Hide source code'
      : 'Show source code';
  });
});


  // wire actions
  document.querySelectorAll('.likeBtn').forEach(btn=>btn.addEventListener('click', e=>{
    const id = e.currentTarget.dataset.id;
    toggleLike(id);
  }));
  document.querySelectorAll('.commentBtn').forEach(btn=>btn.addEventListener('click', e=>{
    const id = e.currentTarget.dataset.id;
    openComments(id);
  }));
  document.querySelectorAll('.saveBtn').forEach(btn=>btn.addEventListener('click', e=>{
    const id = e.currentTarget.dataset.id;
    toggleSave(id);
    renderFeed();
    renderSaved();
  }));
  document.querySelectorAll('.delBtn').forEach(btn=>btn.addEventListener('click', e=>{
    const id = e.currentTarget.dataset.id;
    if(confirm('Delete this post?')) {
      state.data.posts = state.data.posts.filter(p=>p.id!==id);
      saveData();
      renderFeed(); renderMyPosts(); renderSaved();
    }
  }));
}

function toggleLike(postId){
  if(!state.user){ alert('Please login to like.'); showAuth(); return; }
  const p = state.data.posts.find(x=>x.id===postId);
  if(!p) return;
  const idx = p.likes.indexOf(state.user.id);
  if(idx===-1) p.likes.push(state.user.id);
  else p.likes.splice(idx,1);
  saveData();
  renderFeed();
}

function isSaved(postId){
  if(!state.user) return false;
  const arr = state.data.saved[state.user.id]||[];
  return arr.includes(postId);
}

function toggleSave(postId){
  if(!state.user){ alert('Please login to save.'); showAuth(); return; }
  const arr = state.data.saved[state.user.id] || (state.data.saved[state.user.id]=[]);
  const idx = arr.indexOf(postId);
  if(idx===-1) arr.push(postId);
  else arr.splice(idx,1);
  saveData();
  renderSaved();
}

// Replace your old renderSaved() with this robust version
function renderSaved(){
  const box = document.getElementById('savedList');
  if(!box){
    console.error('renderSaved: no element with id "savedList" found');
    return;
  }

  box.innerHTML = '';

  if(!state.user){
    const msg = document.createElement('div');
    msg.style.padding = '8px';
    msg.style.color = '#666';
    msg.textContent = 'Login to see saved posts.';
    box.appendChild(msg);
    return;
  }

  const arr = (state.data && state.data.saved && state.data.saved[state.user.id]) || [];
  if(arr.length === 0){
    const msg = document.createElement('div');
    msg.style.padding = '8px';
    msg.style.color = '#666';
    msg.textContent = 'You have no saved posts.';
    box.appendChild(msg);
    return;
  }

  arr.forEach(id => {
    const p = (state.data && state.data.posts || []).find(x => x.id === id);
    if(!p) return;

    const postEl = document.createElement('div');
    postEl.className = 'post';

    // Meta
    const meta = document.createElement('div');
    meta.className = 'meta';
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = p.avatarLetter || (p.userName && p.userName[0]) || 'U';
    const right = document.createElement('div');
    right.style.flex = '1';
    const uname = document.createElement('div');
    uname.className = 'username';
    uname.textContent = p.userName || 'Unknown';
    const postedTime = document.createElement('div');
    postedTime.className = 'posted-time muted';
    postedTime.textContent = typeof timeAgo === 'function' ? timeAgo(p.createdAt) : (new Date(p.createdAt || Date.now())).toLocaleString();
    right.appendChild(uname);
    right.appendChild(postedTime);
    meta.appendChild(avatar);
    meta.appendChild(right);
    postEl.appendChild(meta);

    // Media (image or video)
    if(p.mediaType === 'image'){
      const img = document.createElement('img');
      img.className = 'post-img';
      img.src = p.media || '';
      img.alt = p.description || '';
      postEl.appendChild(img);
    } else if(p.media){
      const vid = document.createElement('video');
      vid.className = 'post-img';
      vid.src = p.media;
      vid.controls = true;
      postEl.appendChild(vid);
    }

    // Description
    const desc = document.createElement('div');
    desc.className = 'desc';
    desc.textContent = p.description || '';
    postEl.appendChild(desc);

    // Source code area (if present)
    if(p.sourceCode){
      const canView = p.sourcePublic || (state.user && state.user.id === p.userId);

      if(canView){
        // Button to show/hide
        const btn = document.createElement('button');
        btn.className = 'toggle-code';
        btn.dataset.id = p.id;
        btn.type = 'button';
        btn.textContent = 'Show source code';
        postEl.appendChild(btn);

        // Hidden wrapper for code
        const codeWrap = document.createElement('div');
        codeWrap.className = 'code-wrap';
        codeWrap.id = `code-wrap-${p.id}`;
        codeWrap.style.display = 'none'; // hidden initially
        codeWrap.style.marginTop = '8px';

        const pre = document.createElement('pre');
        pre.className = 'code-block';
        pre.style.maxHeight = '360px';
        pre.style.overflow = 'auto';

        const code = document.createElement('code');
        // set language if available on post (fallback to javascript)
        const lang = p.sourceLang || 'javascript';
        code.className = `language-${lang}`;
        // Use textContent so the code is inserted safely (no HTML)
        code.textContent = p.sourceCode;

        pre.appendChild(code);
        codeWrap.appendChild(pre);
        postEl.appendChild(codeWrap);
      } else {
        const note = document.createElement('div');
        note.className = 'small-muted';
        note.style.marginTop = '8px';
        note.textContent = 'Source code is private';
        postEl.appendChild(note);
      }
    }

    box.appendChild(postEl);
  });

  // Attach a single delegated click listener (only once)
  if(!box._hasToggleListener){
    box.addEventListener('click', function(e){
      const btn = e.target.closest && e.target.closest('.toggle-code');
      if(!btn) return;
      const id = btn.dataset.id;
      const wrap = document.getElementById(`code-wrap-${id}`);
      if(!wrap) return;

      const isHidden = wrap.style.display === 'none' || getComputedStyle(wrap).display === 'none';
      if(isHidden){
        wrap.style.display = 'block';
        btn.textContent = 'Hide source code';
        // Highlight if Prism is available
        try {
          if(window.Prism && typeof Prism.highlightElement === 'function'){
            const codeEl = wrap.querySelector('code');
            if(codeEl) Prism.highlightElement(codeEl);
          } else if(window.Prism && typeof Prism.highlightAll === 'function'){
            Prism.highlightAll();
          }
        } catch(err){
          // ignore Prism errors
          console.warn('Prism highlighting failed', err);
        }
      } else {
        wrap.style.display = 'none';
        btn.textContent = 'Show source code';
      }
    });
    box._hasToggleListener = true;
  }
}


function renderProfile(){
  // profile info is updated in updateUserUI
  renderMyPosts();
}

function renderMyPosts(){
  const container = document.getElementById('myPosts');
  container.innerHTML = '';
  if(!state.user){ container.innerHTML = '<div style="padding:8px;color:#666">Login to see your posts.</div>'; return; }
  const mine = state.data.posts.filter(p=>p.userId===state.user.id);
  if(mine.length===0) { container.innerHTML = '<div style="padding:8px;color:#666">You have not posted anything yet.</div>'; return; }
  mine.forEach(p=>{
    const d = document.createElement('div');
    d.className='post';
    d.innerHTML = `<div class="row" style="justify-content:space-between"><div><strong>${escapeHtml(p.description||'Untitled')}</strong><div class="muted">${timeAgo(p.createdAt)}</div></div><div><button class="small-btn delMy" data-id="${p.id}">Delete</button></div></div>`;
    container.appendChild(d);
  });
  document.querySelectorAll('.delMy').forEach(b=>b.addEventListener('click',e=>{
    if(!confirm('Delete this post?')) return;
    const id=e.currentTarget.dataset.id;
    state.data.posts = state.data.posts.filter(p=>p.id!==id);
    saveData();
    renderMyPosts(); renderFeed(); renderSaved();
  }));
}

/* Comments modal */
function openComments(postId){
  const post = state.data.posts.find(x=>x.id===postId);
  if(!post) return;
  const modalRoot = document.getElementById('modalRoot');
  modalRoot.style.display = 'block';
  modalRoot.innerHTML = `
    <div class="modal" role="dialog" aria-modal="true">
      <div class="card">
        <h3>Comments</h3>
        <div class="comments-list">
          ${post.comments.length===0 ? '<div style="padding:8px;color:#666">No comments yet</div>' : post.comments.map(c=>`<div class="comment"><strong>${escapeHtml(c.name)}</strong> <div class="muted">${timeAgo(c.at)}</div><div>${escapeHtml(c.text)}</div></div>`).join('')}
        </div>
        <div style="display:flex;gap:8px">
          <input id="commentText" placeholder="Write a comment" class="input" style="flex:1"/>
          <button id="sendComment" class="small-btn">Send</button>
        </div>
        <div style="text-align:right;margin-top:8px"><button id="closeModal" class="small-btn">Close</button></div>
      </div>
    </div>
  `;
  document.getElementById('closeModal').addEventListener('click', closeModal);
  document.getElementById('sendComment').addEventListener('click', ()=>{
    const txt = document.getElementById('commentText').value.trim();
    if(!txt){ alert('Write something'); return; }
    const cm = { name: state.user ? state.user.name : 'Guest', text: txt, at: Date.now() };
    post.comments.push(cm);
    saveData();
    closeModal();
    openComments(postId);
    renderFeed();
  });
}
function closeModal(){
  const modalRoot = document.getElementById('modalRoot');
  modalRoot.style.display = 'none';
  modalRoot.innerHTML='';
}

/* Simple auth (signup/login) stored locally. Replace with Firebase auth in production. */
function showAuth(){
  const modalRoot = document.getElementById('modalRoot');
  modalRoot.style.display = 'block';
  modalRoot.innerHTML = `
    <div class="modal">
      <div class="card">
        <h3>Sign up / Login</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="authName" class="input" placeholder="Name" />
          <input id="authEmail" class="input" placeholder="Email" />
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="cancelAuth" class="small-btn">Cancel</button>
          <button id="doSignup" class="small-btn">Sign up</button>
          <button id="doLogin" class="small-btn">Login</button>
        </div>
      </div>
    </div>
  `;
  document.getElementById('cancelAuth').addEventListener('click', closeModal);
  document.getElementById('doSignup').addEventListener('click', ()=>{
    const name = document.getElementById('authName').value.trim();
    const email = document.getElementById('authEmail').value.trim();
    if(!name||!email){ alert('Name and email required'); return; }
    // create user
    const id = 'u_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
    const u = { id, name, email };
    state.data.users.push(u);
    saveData();
    localStorage.setItem('codeshare_current_user', id);
    setUserFromStorage();
    closeModal();
  });
  document.getElementById('doLogin').addEventListener('click', ()=>{
    const name = document.getElementById('authName').value.trim();
    const email = document.getElementById('authEmail').value.trim();
    if(!email){ alert('Email required to login'); return; }
    const user = state.data.users.find(x=>x.email.toLowerCase()===email.toLowerCase());
    if(!user){ alert('No account with that email. Sign up first.'); return; }
    localStorage.setItem('codeshare_current_user', user.id);
    setUserFromStorage();
    closeModal();
  });
}

// function logout(){
//   localStorage.removeItem('codeshare_current_user');
//   state.user = null;
//   updateUserUI();
// }



/* ---------- 1. Logout confirmation ---------- */
function  logout(){
  const modalRoot = document.getElementById('modalRoot');
  modalRoot.style.display = 'block';
  modalRoot.innerHTML = `
    <div class="modal">
      <div class="card">
        <h3>Confirm Logout</h3>
        <p>Do you really want to log out?</p>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
          <button id="cancelLogout" class="small-btn">Cancel</button>
          <button id="doLogout" class="small-btn danger">Log out</button>
        </div>
      </div>
    </div>`;
  document.getElementById('cancelLogout').addEventListener('click', closeModal);
  document.getElementById('doLogout').addEventListener('click', ()=>{
    localStorage.removeItem('codeshare_current_user');
    state.user = null;
    updateUserUI();
    closeModal();
  });
}


/* Utility helpers */
function timeAgo(ts){
  const sec = Math.floor((Date.now() - ts)/1000);
  if(sec<60) return `${sec}s`;
  if(sec<3600) return `${Math.floor(sec/60)}m`;
  if(sec<86400) return `${Math.floor(sec/3600)}h`;
  return `${Math.floor(sec/86400)}d`;
}
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

/* Boot */
init();

/* ---------------------------
  NOTES for hooking a real backend (Firebase example)
  - Replace local.get / local.set / localStorage logic with:
    - Firestore collections: posts, users, saved
    - Use Firebase Authentication for users (email/password)
  - Example (pseudo):
    // when creating a post:
    const docRef = await firestore.collection('posts').add({ ...postData });
    // when liking:
    await firestore.collection('posts').doc(postId).update({ likes: firebase.firestore.FieldValue.arrayUnion(userId) });
  - For media upload: use Firebase Storage. Upload the file and get a public URL, store that URL in Firestore post document.
  - Replace showAuth / logout with firebase.auth() signIn and signUp flows.
--------------------------- */

</script>
</body>
</html>
